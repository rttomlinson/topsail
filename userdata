#!/bin/bash
yum clean all

yum -y install yq jq curl gcc make perl libc-dev perl-dev unzip \
    && curl -L https://cpanmin.us | perl - --no-wget App::cpanminus

yum -y remove awscli
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
./aws/install --update

yum -y install git

yum install docker -y
systemctl enable docker
service docker start
usermod -a -G docker ec2-user

# make sure /tmp exists and is accessible to everyone?

# create the runner user
# create the cron to execute as the runner user
# runner user gets tmp dir set from

yum -y install amazon-cloudwatch-agent
# doesn't seem like we need to "start" it
# default run as root
# we might need to configure for instance and container metrics but logging seems to be working

# mkdir -p /opt/aws/amazon-cloudwatch-agent/etc
# touch /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json

# opt/aws/amazon-cloudwatch-agent/bin/config.json

# configure the cloudwatch agent via file

# /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -s -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json

echo "end userdata"